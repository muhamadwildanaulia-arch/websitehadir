<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Kehadiran Guru SDN Muhara</title>
  <script src="https://cdn.tailwindcss.com"></script><!-- SDK scripts removed for Netlify deployment -->
  <style>
        body {
            box-sizing: border-box;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            min-height: 100%;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        .modern-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(220, 38, 38, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .glass-input:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        .gradient-button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }
        .gradient-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .gradient-button:hover::before {
            left: 100%;
        }
        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }
        .modern-tab {
            border-radius: 12px 12px 0 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .modern-tab.active {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            transform: translateY(-2px);
        }
        .modern-tab:hover:not(.active) {
            background: rgba(220, 38, 38, 0.1);
            transform: translateY(-1px);
        }
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .header-gradient {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 50%, #f8fafc 100%);
            position: relative;
            overflow: hidden;
        }
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .table-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .table-modern th {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .table-modern tr:hover {
            background: rgba(220, 38, 38, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        .icon-bounce {
            display: inline-block;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        .gradient-text {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        .digital-clock {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .digital-clock:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        .time-segment {
            position: relative;
        }
        .time-segment::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .time-segment:hover::before {
            opacity: 1;
        }
        .time-separator {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .stats-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full font-sans">
  <div class="min-h-full p-4"><!-- Header -->
   <div id="header-container" class="modern-card header-gradient mb-8 p-8 relative overflow-hidden floating-animation"><!-- Upload Controls -->
    <div class="relative z-10 mb-6 flex justify-center">
     <div class="flex items-center gap-2"><label for="logo-upload" class="gradient-button text-white px-6 py-3 cursor-pointer text-sm font-semibold"> <span class="icon-bounce">ğŸ“¸</span> Upload Logo </label> <input type="file" id="logo-upload" accept="image/*" class="hidden"> <button id="remove-logo" class="gradient-button bg-red-500 text-white px-4 py-3 text-sm hidden"> âœ• </button>
     </div>
    </div><!-- Header Content -->
    <div class="relative z-10 flex items-center justify-center gap-8"><!-- Logo -->
     <div id="logo-container" class="hidden floating-animation"><img id="school-logo" class="w-20 h-20 object-contain rounded-full border-4 border-white shadow-lg" alt="Logo Sekolah">
     </div><!-- Title and School Info -->
     <div class="text-center">
      <h1 id="app-title" class="text-3xl font-bold text-red-600 mb-3 drop-shadow-lg">Aplikasi Kehadiran Guru SDN Muhara</h1>
      <p id="school-name" class="text-red-700 text-xl font-semibold">SDN Muhara</p>
      <p class="text-sm text-gray-600 mt-3 pulse-animation" id="current-date"></p><!-- Digital Clock -->
      <div class="mt-6 flex justify-center">
       <div class="digital-clock bg-red-600 bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-2xl px-8 py-4 border border-red-500 border-opacity-30">
        <div class="flex items-center justify-center space-x-2">
         <div class="time-segment"><span id="hours" class="text-4xl font-mono font-bold text-white tracking-wider">00</span>
         </div>
         <div class="time-separator"><span id="separator1" class="text-4xl font-mono font-bold text-white opacity-75">:</span>
         </div>
         <div class="time-segment"><span id="minutes" class="text-4xl font-mono font-bold text-white tracking-wider">00</span>
         </div>
         <div class="time-separator"><span id="separator2" class="text-4xl font-mono font-bold text-white opacity-75">:</span>
         </div>
         <div class="time-segment"><span id="seconds" class="text-2xl font-mono font-bold text-white tracking-wider opacity-90">00</span>
         </div>
         <div class="ml-3"><span id="ampm" class="text-lg font-semibold text-white opacity-80">AM</span>
         </div>
        </div>
        <div class="text-center mt-2"><span class="text-xs text-white opacity-60 font-medium tracking-wide">WAKTU INDONESIA BARAT</span>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Navigation Tabs -->
   <div class="modern-card mb-6 overflow-hidden">
    <div class="flex"><button onclick="switchTab('kehadiran')" id="tab-kehadiran" class="modern-tab active flex-1 py-5 px-8 text-center font-semibold text-white"> <span class="icon-bounce">âœ…</span> Kehadiran </button> <button onclick="switchTab('guru')" id="tab-guru" class="modern-tab flex-1 py-5 px-8 text-center font-semibold text-gray-600"> <span class="icon-bounce">ğŸ‘¥</span> Data Guru </button> <button onclick="switchTab('laporan')" id="tab-laporan" class="modern-tab flex-1 py-5 px-8 text-center font-semibold text-gray-600"> <span class="icon-bounce">ğŸ“Š</span> Laporan </button>
    </div>
   </div><!-- Tab Content -->
   <div class="modern-card p-8"><!-- Tab Kehadiran -->
    <div id="content-kehadiran" class="tab-content active">
     <h2 class="text-2xl font-bold gradient-text mb-8 text-center">ğŸ“ Input Kehadiran Guru</h2>
     <form id="attendance-form" class="space-y-8">
      <div class="grid md:grid-cols-2 gap-8">
       <div><label for="nama-guru-kehadiran" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ‘¤ Nama Guru</label> <select id="nama-guru-kehadiran" required class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium"> <option value="">-- Pilih Guru --</option> </select>
       </div>
       <div><label for="status-kehadiran" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ“Š Status Kehadiran</label> <select id="status-kehadiran" required class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium"> <option value="">-- Pilih Status --</option> <option value="Hadir">âœ… Hadir</option> <option value="Sakit">ğŸ¤’ Sakit</option> <option value="Izin">ğŸ“ Izin</option> <option value="Dinas Luar">ğŸš— Dinas Luar</option> </select>
       </div>
      </div>
      <div><label for="keterangan-lokasi" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ“ Keterangan Lokasi</label>
       <div class="relative"><input type="text" id="keterangan-lokasi" required class="glass-input w-full p-4 pr-12 focus:outline-none text-gray-700 font-medium" placeholder="Tulis lokasi atau klik GPS untuk lokasi otomatis"> <button type="button" id="get-gps-location" class="absolute right-2 top-1/2 transform -translate-y-1/2 gradient-button text-white px-3 py-2 text-sm rounded-lg" title="Dapatkan Lokasi GPS"> ğŸŒ GPS </button>
       </div>
       <div class="mt-2 text-xs text-gray-500">
        ğŸ’¡ Tulis lokasi secara manual atau klik tombol GPS untuk mendapatkan lokasi otomatis
       </div>
      </div><!-- GPS Location Display -->
      <div id="gps-info" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
       <h4 class="font-semibold text-blue-800 mb-2">ğŸŒ Informasi GPS</h4>
       <div class="grid md:grid-cols-2 gap-4 text-sm">
        <div><span class="font-medium text-blue-700">ğŸ“ Koordinat:</span>
         <div id="gps-coordinates" class="text-blue-600 font-mono">
          -
         </div>
        </div>
        <div><span class="font-medium text-blue-700">ğŸ“ Alamat:</span>
         <div id="gps-address" class="text-blue-600">
          Sedang mencari alamat...
         </div>
        </div>
        <div><span class="font-medium text-blue-700">â° Waktu:</span>
         <div id="gps-time" class="text-blue-600">
          -
         </div>
        </div>
        <div><span class="font-medium text-blue-700">ğŸ¯ Akurasi:</span>
         <div id="gps-accuracy" class="text-blue-600">
          -
         </div>
        </div>
       </div>
       <div class="mt-3 flex gap-2"><button type="button" id="refresh-gps" class="gradient-button text-white px-4 py-2 text-sm"> ğŸ”„ Refresh GPS </button> <button type="button" id="use-gps-location" class="gradient-button bg-green-500 text-white px-4 py-2 text-sm"> âœ… Gunakan Lokasi Ini </button> <button type="button" id="close-gps" class="gradient-button bg-gray-500 text-white px-4 py-2 text-sm"> âŒ Tutup </button>
       </div>
      </div><button type="submit" id="submit-attendance" class="gradient-button w-full text-white py-4 px-8 font-bold text-lg"> ğŸ’¾ Simpan Kehadiran </button>
     </form><!-- Grafik Kehadiran -->
     <div class="mt-16 grid md:grid-cols-2 gap-8"><!-- Grafik Donut -->
      <div class="chart-container p-8 floating-animation">
       <h3 class="text-xl font-bold gradient-text mb-8 text-center">ğŸ“Š Statistik Kehadiran Hari Ini</h3>
       <div class="flex items-center justify-center">
        <div class="relative w-48 h-48">
         <svg class="w-48 h-48 transform -rotate-90" viewbox="0 0 100 100"><!-- Background circle --> <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" /> <!-- Hadir --> <circle id="chart-hadir" cx="50" cy="50" r="40" stroke="#10b981" stroke-width="8" fill="none" stroke-dasharray="0 251.2" stroke-linecap="round" /> <!-- Sakit --> <circle id="chart-sakit" cx="50" cy="50" r="40" stroke="#ef4444" stroke-width="8" fill="none" stroke-dasharray="0 251.2" stroke-linecap="round" /> <!-- Izin --> <circle id="chart-izin" cx="50" cy="50" r="40" stroke="#f59e0b" stroke-width="8" fill="none" stroke-dasharray="0 251.2" stroke-linecap="round" /> <!-- Dinas Luar --> <circle id="chart-dinas" cx="50" cy="50" r="40" stroke="#3b82f6" stroke-width="8" fill="none" stroke-dasharray="0 251.2" stroke-linecap="round" />
         </svg>
         <div class="absolute inset-0 flex items-center justify-center">
          <div class="text-center">
           <div id="total-attendance" class="text-2xl font-bold text-gray-800">
            0
           </div>
           <div class="text-sm text-gray-600">
            Total
           </div>
          </div>
         </div>
        </div>
       </div><!-- Legend -->
       <div class="mt-6 grid grid-cols-2 gap-3 text-sm">
        <div class="flex items-center">
         <div class="w-2 h-2 bg-gray-800 rounded-full mr-3"></div><span class="text-gray-600">Hadir: <span id="legend-hadir" class="font-medium text-gray-900">0</span></span>
        </div>
        <div class="flex items-center">
         <div class="w-2 h-2 bg-gray-500 rounded-full mr-3"></div><span class="text-gray-600">Sakit: <span id="legend-sakit" class="font-medium text-gray-900">0</span></span>
        </div>
        <div class="flex items-center">
         <div class="w-2 h-2 bg-gray-400 rounded-full mr-3"></div><span class="text-gray-600">Izin: <span id="legend-izin" class="font-medium text-gray-900">0</span></span>
        </div>
        <div class="flex items-center">
         <div class="w-2 h-2 bg-gray-300 rounded-full mr-3"></div><span class="text-gray-600">Dinas: <span id="legend-dinas" class="font-medium text-gray-900">0</span></span>
        </div>
       </div>
      </div><!-- Grafik Bar Mingguan -->
      <div class="chart-container p-8 floating-animation">
       <h3 class="text-xl font-bold gradient-text mb-8 text-center">ğŸ“ˆ Tren Kehadiran 7 Hari Terakhir</h3>
       <div class="h-48 flex items-end justify-between space-x-2">
        <div class="flex flex-col items-center flex-1">
         <div class="w-full bg-gray-200 rounded-t" style="height: 120px; position: relative;">
          <div id="bar-0" class="bg-red-500 rounded-t transition-all duration-500" style="width: 100%; height: 0%; position: absolute; bottom: 0;"></div>
         </div>
         <div class="text-xs mt-2 text-center" id="day-0">
          Sen
         </div>
         <div class="text-xs font-bold" id="count-0">
          0
         </div>
        </div>
        <div class="flex flex-col items-center flex-1">
         <div class="w-full bg-gray-200 rounded-t" style="height: 120px; position: relative;">
          <div id="bar-1" class="bg-red-500 rounded-t transition-all duration-500" style="width: 100%; height: 0%; position: absolute; bottom: 0;"></div>
         </div>
         <div class="text-xs mt-2 text-center" id="day-1">
          Sel
         </div>
         <div class="text-xs font-bold" id="count-1">
          0
         </div>
        </div>
        <div class="flex flex-col items-center flex-1">
         <div class="w-full bg-gray-200 rounded-t" style="height: 120px; position: relative;">
          <div id="bar-2" class="bg-red-500 rounded-t transition-all duration-500" style="width: 100%; height: 0%; position: absolute; bottom: 0;"></div>
         </div>
         <div class="text-xs mt-2 text-center" id="day-2">
          Rab
         </div>
         <div class="text-xs font-bold" id="count-2">
          0
         </div>
        </div>
        <div class="flex flex-col items-center flex-1">
         <div class="w-full bg-gray-200 rounded-t" style="height: 120px; position: relative;">
          <div id="bar-3" class="bg-red-500 rounded-t transition-all duration-500" style="width: 100%; height: 0%; position: absolute; bottom: 0;"></div>
         </div>
         <div class="text-xs mt-2 text-center" id="day-3">
          Kam
         </div>
         <div class="text-xs font-bold" id="count-3">
          0
         </div>
        </div>
        <div class="flex flex-col items-center flex-1">
         <div class="w-full bg-gray-200 rounded-t" style="height: 120px; position: relative;">
          <div id="bar-4" class="bg-red-500 rounded-t transition-all duration-500" style="width: 100%; height: 0%; position: absolute; bottom: 0;"></div>
         </div>
         <div class="text-xs mt-2 text-center" id="day-4">
          Jum
         </div>
         <div class="text-xs font-bold" id="count-4">
          0
         </div>
        </div>
        <div class="flex flex-col items-center flex-1">
         <div class="w-full bg-gray-200 rounded-t" style="height: 120px; position: relative;">
          <div id="bar-5" class="bg-red-500 rounded-t transition-all duration-500" style="width: 100%; height: 0%; position: absolute; bottom: 0;"></div>
         </div>
         <div class="text-xs mt-2 text-center" id="day-5">
          Sab
         </div>
         <div class="text-xs font-bold" id="count-5">
          0
         </div>
        </div>
        <div class="flex flex-col items-center flex-1">
         <div class="w-full bg-gray-200 rounded-t" style="height: 120px; position: relative;">
          <div id="bar-6" class="bg-red-500 rounded-t transition-all duration-500" style="width: 100%; height: 0%; position: absolute; bottom: 0;"></div>
         </div>
         <div class="text-xs mt-2 text-center" id="day-6">
          Min
         </div>
         <div class="text-xs font-bold" id="count-6">
          0
         </div>
        </div>
       </div>
      </div>
     </div><!-- Daftar Kehadiran Hari Ini -->
     <div class="mt-16">
      <h3 class="text-xl font-bold gradient-text mb-8 text-center">ğŸ“‹ Daftar Kehadiran Hari Ini</h3>
      <div class="overflow-x-auto">
       <table class="w-full table-modern">
        <thead>
         <tr>
          <th class="p-6 text-left text-sm font-bold">ğŸ‘¤ Nama Guru</th>
          <th class="p-6 text-left text-sm font-bold">ğŸ“Š Status</th>
          <th class="p-6 text-left text-sm font-bold">â° Jam Hadir</th>
          <th class="p-6 text-left text-sm font-bold">ğŸ“ Keterangan Lokasi</th>
          <th class="p-6 text-left text-sm font-bold">ğŸŒ GPS</th>
         </tr>
        </thead>
        <tbody id="attendance-list">
         <tr>
          <td colspan="5" class="p-8 text-center text-gray-500 text-lg font-medium">ğŸ” Belum ada data kehadiran hari ini</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Tab Data Guru -->
    <div id="content-guru" class="tab-content">
     <h2 class="text-2xl font-bold gradient-text mb-8 text-center">ğŸ‘¥ Manajemen Data Guru</h2>
     <form id="guru-form" class="space-y-8 mb-16">
      <div class="grid md:grid-cols-2 gap-8">
       <div><label for="nama-guru" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ‘¤ Nama Guru</label> <input type="text" id="nama-guru" required class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium" placeholder="Masukkan nama guru">
       </div>
       <div><label for="nip-guru" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ†” NIP</label> <input type="text" id="nip-guru" required class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium" placeholder="Masukkan NIP">
       </div>
      </div>
      <div><label for="jabatan-guru" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ’¼ Jabatan</label> <select id="jabatan-guru" required class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium"> <option value="">-- Pilih Jabatan --</option> <option value="Kepala Sekolah">ğŸ‘‘ Kepala Sekolah</option> <option value="Wakil Kepala Sekolah">ğŸ¯ Wakil Kepala Sekolah</option> <option value="Guru Kelas">ğŸ‘©â€ğŸ« Guru Kelas</option> <option value="Guru Mata Pelajaran">ğŸ“š Guru Mata Pelajaran</option> <option value="Guru Olahraga">âš½ Guru Olahraga</option> <option value="Guru Agama">ğŸ•Œ Guru Agama</option> <option value="Guru Bahasa Inggris">ğŸŒ Guru Bahasa Inggris</option> <option value="Guru Seni Budaya">ğŸ¨ Guru Seni Budaya</option> <option value="Guru BK">ğŸ’¬ Guru BK (Bimbingan Konseling)</option> <option value="Pustakawan">ğŸ“– Pustakawan</option> <option value="Tenaga Administrasi">ğŸ“‹ Tenaga Administrasi</option> </select>
      </div>
      <div><label for="status-kepegawaian" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ“„ Status Kepegawaian</label> <select id="status-kepegawaian" required class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium"> <option value="">-- Pilih Status Kepegawaian --</option> <option value="PNS">ğŸ‘¨â€ğŸ’¼ PNS</option> <option value="PPPK">ğŸ“‹ PPPK</option> <option value="GTT">ğŸ“ GTT (Guru Tidak Tetap)</option> <option value="GTY">ğŸ“ GTY (Guru Tetap Yayasan)</option> <option value="Honorer">ğŸ’¼ Honorer</option> </select>
      </div>
      <div class="flex gap-6"><button type="submit" id="submit-guru" class="gradient-button text-white py-4 px-8 font-bold text-lg flex-1"> â• Tambah Guru </button> <button type="button" id="cancel-edit" class="gradient-button bg-red-500 text-white py-4 px-8 font-bold text-lg hidden"> âŒ Batal Edit </button>
      </div>
     </form><!-- Daftar Guru -->
     <div>
      <h3 class="text-xl font-bold gradient-text mb-8 text-center">ğŸ“‹ Daftar Guru</h3>
      <div class="overflow-x-auto">
       <table class="w-full table-modern">
        <thead>
         <tr>
          <th class="p-6 text-left text-sm font-bold">ğŸ‘¤ Nama</th>
          <th class="p-6 text-left text-sm font-bold">ğŸ†” NIP</th>
          <th class="p-6 text-left text-sm font-bold">ğŸ’¼ Jabatan</th>
          <th class="p-6 text-left text-sm font-bold">ğŸ“„ Status Kepegawaian</th>
          <th class="p-6 text-left text-sm font-bold">âš™ï¸ Aksi</th>
         </tr>
        </thead>
        <tbody id="guru-list">
         <tr>
          <td colspan="5" class="p-8 text-center text-gray-500 text-lg font-medium">ğŸ” Belum ada data guru</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Tab Laporan -->
    <div id="content-laporan" class="tab-content">
     <h2 class="text-2xl font-bold gradient-text mb-8 text-center">ğŸ“Š Laporan Rekap Kehadiran</h2>
     <div class="mb-12 grid md:grid-cols-3 gap-6">
      <div><label for="filter-bulan" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ“… Bulan</label> <select id="filter-bulan" class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium"> <option value="">Semua Bulan</option> <option value="01">Januari</option> <option value="02">Februari</option> <option value="03">Maret</option> <option value="04">April</option> <option value="05">Mei</option> <option value="06">Juni</option> <option value="07">Juli</option> <option value="08">Agustus</option> <option value="09">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option> </select>
      </div>
      <div><label for="filter-tahun" class="block text-sm font-semibold text-gray-700 mb-3">ğŸ“† Tahun</label> <select id="filter-tahun" class="glass-input w-full p-4 focus:outline-none text-gray-700 font-medium"> </select>
      </div>
      <div class="flex items-end"><button onclick="generateReport()" class="gradient-button w-full text-white py-4 px-8 font-bold text-lg"> ğŸ“ˆ Generate Laporan </button>
      </div>
     </div><!-- Download Options -->
     <div id="download-section" class="mb-12 hidden">
      <div class="chart-container p-6">
       <h3 class="text-lg font-bold gradient-text mb-6 text-center">ğŸ’¾ Download Laporan</h3>
       <div class="flex flex-wrap gap-4 justify-center"><button onclick="downloadExcel()" class="gradient-button text-white px-6 py-3 text-sm font-bold"> ğŸ“Š Excel </button> <button onclick="downloadCSV()" class="gradient-button text-white px-6 py-3 text-sm font-bold"> ğŸ“„ CSV </button> <button onclick="downloadPDF()" class="gradient-button text-white px-6 py-3 text-sm font-bold"> ğŸ“‹ PDF </button>
       </div>
      </div>
     </div><!-- Statistik -->
     <div id="statistics" class="grid md:grid-cols-5 gap-6 mb-8 hidden">
      <div class="stats-card bg-green-100 p-6 text-center">
       <h4 class="font-bold text-green-800 mb-2">âœ… Total Hadir</h4>
       <p id="stat-hadir" class="text-3xl font-bold text-green-600">0</p>
      </div>
      <div class="stats-card bg-red-100 p-6 text-center">
       <h4 class="font-bold text-red-800 mb-2">ğŸ¤’ Total Sakit</h4>
       <p id="stat-sakit" class="text-3xl font-bold text-red-600">0</p>
      </div>
      <div class="stats-card bg-yellow-100 p-6 text-center">
       <h4 class="font-bold text-yellow-800 mb-2">ğŸ“ Total Izin</h4>
       <p id="stat-izin" class="text-3xl font-bold text-yellow-600">0</p>
      </div>
      <div class="stats-card bg-blue-100 p-6 text-center">
       <h4 class="font-bold text-blue-800 mb-2">ğŸš— Total Dinas Luar</h4>
       <p id="stat-dinas" class="text-3xl font-bold text-blue-600">0</p>
      </div>
      <div class="stats-card bg-gray-100 p-6 text-center">
       <h4 class="font-bold text-gray-800 mb-2">âŒ Tanpa Keterangan</h4>
       <p id="stat-tanpa-keterangan" class="text-3xl font-bold text-gray-600">0</p>
      </div>
     </div><!-- Tabel Laporan Detail -->
     <div class="overflow-x-auto">
      <table class="w-full table-modern">
       <thead id="report-header">
        <tr>
         <th class="p-6 text-left sticky left-0 z-10 font-bold">ğŸ‘¤ Nama Guru</th>
        </tr>
       </thead>
       <tbody id="report-table">
        <tr>
         <td class="p-8 text-center text-gray-500 text-lg font-medium">ğŸ” Klik "Generate Laporan" untuk melihat data</td>
        </tr>
       </tbody>
      </table>
     </div><!-- Resume Laporan -->
     <div id="resume-section" class="mt-12 hidden">
      <h3 class="text-2xl font-bold gradient-text mb-8 text-center">ğŸ“ˆ Resume Kehadiran</h3>
      <div class="chart-container p-8">
       <div class="grid md:grid-cols-2 gap-6">
        <div>
         <h4 class="font-semibold text-gray-700 mb-3">Statistik Keseluruhan</h4>
         <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span>Total Hari Kerja:</span> <span id="resume-total-days" class="font-bold">0 hari</span>
          </div>
          <div class="flex justify-between"><span>Total Kehadiran:</span> <span id="resume-total-attendance" class="font-bold">0 record</span>
          </div>
          <div class="flex justify-between"><span>Rata-rata Kehadiran per Hari:</span> <span id="resume-avg-daily" class="font-bold">0 guru</span>
          </div>
         </div>
        </div>
        <div>
         <h4 class="font-semibold text-gray-700 mb-3">Persentase Status</h4>
         <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>Hadir:</span> <span id="resume-percent-hadir" class="font-bold">0%</span>
          </div>
          <div class="flex justify-between"><span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>Sakit:</span> <span id="resume-percent-sakit" class="font-bold">0%</span>
          </div>
          <div class="flex justify-between"><span class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>Izin:</span> <span id="resume-percent-izin" class="font-bold">0%</span>
          </div>
          <div class="flex justify-between"><span class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>Dinas Luar:</span> <span id="resume-percent-dinas" class="font-bold">0%</span>
          </div>
          <div class="flex justify-between"><span class="flex items-center"><span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>Tanpa Keterangan:</span> <span id="resume-percent-tanpa-keterangan" class="font-bold">0%</span>
          </div>
         </div>
        </div>
       </div><!-- Guru dengan Kehadiran Terbaik dan Terburuk -->
       <div class="mt-6 grid md:grid-cols-2 gap-6">
        <div class="bg-green-50 p-4 rounded-lg">
         <h5 class="font-semibold text-green-800 mb-2">ğŸ† Kehadiran Terbaik</h5>
         <div id="best-attendance" class="text-sm text-green-700">
          Belum ada data
         </div>
        </div>
        <div class="bg-red-50 p-4 rounded-lg">
         <h5 class="font-semibold text-red-800 mb-2">âš ï¸ Perlu Perhatian</h5>
         <div id="attention-needed" class="text-sm text-red-700">
          Belum ada data
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            app_title: "Aplikasi Kehadiran Guru SDN Muhara",
            school_name: "SDN Muhara"
        };

        // Global variables
        let teachers = [];
        let attendanceRecords = [];
        let editingTeacher = null;

        // Digital Clock Function
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            // Convert to 12-hour format
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            
            // Add leading zeros
            const hoursStr = hours.toString().padStart(2, '0');
            const minutesStr = minutes.toString().padStart(2, '0');
            const secondsStr = seconds.toString().padStart(2, '0');
            
            // Update clock display
            document.getElementById('hours').textContent = hoursStr;
            document.getElementById('minutes').textContent = minutesStr;
            document.getElementById('seconds').textContent = secondsStr;
            document.getElementById('ampm').textContent = ampm;
        }

        // Initialize app for Netlify deployment
        async function initializeApp() {
            // Load data from localStorage for Netlify deployment
            loadDataFromStorage();

            // Set current date
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Initialize digital clock
            updateClock();
            setInterval(updateClock, 1000);

            // Initialize year filter
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('filter-tahun');
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // LocalStorage functions for Netlify deployment
        async function saveDataToServer(data) {
			const sheetURL = "https://script.google.com/macros/s/AKfycbxPUXd7u8CM4pO5R4iJguBdLIzVugwir5cdWiAeZBnaUvLvNDLEupqV2owOmS71bK_s/exec";
			try {
			  const response = await fetch(sheetURL, {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" }
			  });
			  const text = await response.text();
                console.log("Respon server:", text);
            } catch (error) {
              console.error("Gagal kirim data ke Google Sheets:", error);
              alert("âŒ Gagal menyimpan ke Google Sheets. Cek koneksi atau izin Web App.");
			}
		}

        function loadDataFromStorage() {
            try {
                const storedTeachers = localStorage.getItem('teachers');
                const storedAttendance = localStorage.getItem('attendanceRecords');
                
                if (storedTeachers) {
                    teachers = JSON.parse(storedTeachers);
                }
                
                if (storedAttendance) {
                    attendanceRecords = JSON.parse(storedAttendance);
                }
                
                // Update UI after loading data
                updateTeacherList();
                updateAttendanceList();
                updateTeacherDropdown();
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                teachers = [];
                attendanceRecords = [];
            }
        }

        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('active');
                tab.className = 'modern-tab flex-1 py-5 px-8 text-center font-semibold text-gray-600';
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.add('active');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('active');
            activeTab.className = 'modern-tab active flex-1 py-5 px-8 text-center font-semibold text-white';
        }

        // Teacher management
        document.getElementById('guru-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-guru');
            submitBtn.classList.add('loading');
            submitBtn.textContent = 'Menyimpan...';
            
            const nama = document.getElementById('nama-guru').value;
            const nip = document.getElementById('nip-guru').value;
            const jabatan = document.getElementById('jabatan-guru').value;
            const statusKepegawaian = document.getElementById('status-kepegawaian').value;
            
            const teacherData = {
                type: 'teacher',
                nama_guru: nama,
                nip: nip,
                jabatan: jabatan,
                status_kepegawaian: statusKepegawaian,
                created_at: new Date().toISOString(),
                __backendId: editingTeacher ? editingTeacher.__backendId : generateId()
            };

            try {
                if (editingTeacher) {
                    // Update existing teacher
                    const index = teachers.findIndex(t => t.__backendId === editingTeacher.__backendId);
                    if (index !== -1) {
                        teachers[index] = teacherData;
                    }
                } else {
                    if (teachers.length >= 999) {
                        showMessage('Maksimal 999 guru dapat disimpan. Hapus beberapa data terlebih dahulu.', 'error');
                        submitBtn.classList.remove('loading');
                        submitBtn.textContent = 'â• Tambah Guru';
                        return;
                    }
                    // Add new teacher
                    teachers.push(teacherData);
                }

                // Save to localStorage
                saveDataToStorage();
				saveDataToServer(teacherData);
                
                // Update UI
                updateTeacherList();
                updateTeacherDropdown();
                
                showMessage(editingTeacher ? 'Data guru berhasil diupdate!' : 'Guru berhasil ditambahkan!', 'success');
                document.getElementById('guru-form').reset();
                cancelEdit();
            } catch (error) {
                console.error('Error saving teacher:', error);
                showMessage('Gagal menyimpan data guru. Silakan coba lagi.', 'error');
            }
            
            submitBtn.classList.remove('loading');
            submitBtn.textContent = editingTeacher ? 'âœï¸ Update Guru' : 'â• Tambah Guru';
        });

        // Attendance management
        document.getElementById('attendance-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (attendanceRecords.length >= 999) {
                showMessage('Maksimal 999 record kehadiran dapat disimpan. Hapus beberapa data terlebih dahulu.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submit-attendance');
            submitBtn.classList.add('loading');
            submitBtn.textContent = 'Menyimpan...';
            
            const namaGuru = document.getElementById('nama-guru-kehadiran').value;
            const status = document.getElementById('status-kehadiran').value;
            const keteranganLokasi = document.getElementById('keterangan-lokasi').value;
            
            const now = new Date();
            
            const attendanceData = {
                type: 'attendance',
                nama_guru: namaGuru,
                status: status,
                jam_hadir: now.toLocaleTimeString('id-ID'),
                tanggal: now.toISOString().split('T')[0],
                keterangan_lokasi: keteranganLokasi,
                gps_data: currentGPSData ? {
                    latitude: currentGPSData.latitude,
                    longitude: currentGPSData.longitude,
                    accuracy: currentGPSData.accuracy,
                    address: currentGPSData.address ? currentGPSData.address.shortAddress : null,
                    timestamp: currentGPSData.timestamp
                } : null,
                created_at: now.toISOString(),
                __backendId: generateId()
            };

            try {
                // Add to attendance records
                attendanceRecords.push(attendanceData);
                
                // Save to localStorage
                saveDataToStorage();
				saveDataToServer(attendanceData);
                
                // Update UI
                updateAttendanceList();
                
                showMessage('Kehadiran berhasil disimpan!', 'success');
                document.getElementById('attendance-form').reset();
            } catch (error) {
                console.error('Error saving attendance:', error);
                showMessage('Gagal menyimpan kehadiran. Silakan coba lagi.', 'error');
            }
            
            submitBtn.classList.remove('loading');
            submitBtn.textContent = 'ğŸ’¾ Simpan Kehadiran';
        });

        function updateTeacherList() {
            const tbody = document.getElementById('guru-list');
            
            if (teachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500 text-lg font-medium">ğŸ” Belum ada data guru</td></tr>';
            } else {
                tbody.innerHTML = teachers.map(teacher => `
                    <tr>
                        <td class="p-6">${teacher.nama_guru}</td>
                        <td class="p-6">${teacher.nip}</td>
                        <td class="p-6">
                            <span class="status-badge ${getJabatanColor(teacher.jabatan)}">
                                ${getJabatanIcon(teacher.jabatan)} ${teacher.jabatan}
                            </span>
                        </td>
                        <td class="p-6">
                            <span class="status-badge ${getStatusKepegawaianColor(teacher.status_kepegawaian)}">
                                ${getStatusKepegawaianIcon(teacher.status_kepegawaian)} ${teacher.status_kepegawaian}
                            </span>
                        </td>
                        <td class="p-6">
                            <button onclick="editTeacher('${teacher.__backendId}')" class="gradient-button text-white px-4 py-2 text-sm mr-2">
                                âœï¸ Edit
                            </button>
                            <button onclick="deleteTeacher('${teacher.__backendId}')" class="gradient-button bg-red-500 text-white px-4 py-2 text-sm">
                                ğŸ—‘ï¸ Hapus
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function updateAttendanceList() {
            const tbody = document.getElementById('attendance-list');
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceRecords.filter(record => record.tanggal === today);
            
            if (todayAttendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500 text-lg font-medium">ğŸ” Belum ada data kehadiran hari ini</td></tr>';
            } else {
                tbody.innerHTML = todayAttendance.map(record => `
                    <tr>
                        <td class="p-6">${record.nama_guru}</td>
                        <td class="p-6">
                            <span class="status-badge ${getStatusColor(record.status)}">
                                ${getStatusIcon(record.status)} ${record.status}
                            </span>
                        </td>
                        <td class="p-6">${record.jam_hadir}</td>
                        <td class="p-6">
                            ${record.keterangan_lokasi ? 
                                `<div class="text-sm font-medium">${record.keterangan_lokasi}</div>` : 
                                '<span class="text-gray-400">-</span>'
                            }
                        </td>
                        <td class="p-6">
                            ${record.gps_data ? 
                                `<div class="text-xs">
                                    <div class="font-mono text-blue-600">${record.gps_data.latitude.toFixed(4)}, ${record.gps_data.longitude.toFixed(4)}</div>
                                    <div class="text-gray-500">Â±${Math.round(record.gps_data.accuracy)}m</div>
                                    ${record.gps_data.address ? `<div class="text-gray-600 mt-1">${record.gps_data.address}</div>` : ''}
                                </div>` : 
                                '<span class="text-gray-400">-</span>'
                            }
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update charts
            updateCharts();
        }

        function updateTeacherDropdown() {
            const dropdown = document.getElementById('nama-guru-kehadiran');
            
            // Clear existing options except the first one
            dropdown.innerHTML = '<option value="">-- Pilih Guru --</option>';
            
            // Add teacher options
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.nama_guru;
                option.textContent = teacher.nama_guru;
                dropdown.appendChild(option);
            });
        }

        function updateCharts() {
            updateDonutChart();
            updateWeeklyChart();
        }

        function updateDonutChart() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceRecords.filter(record => record.tanggal === today);
            
            const stats = {
                hadir: todayAttendance.filter(r => r.status === 'Hadir').length,
                sakit: todayAttendance.filter(r => r.status === 'Sakit').length,
                izin: todayAttendance.filter(r => r.status === 'Izin').length,
                dinas: todayAttendance.filter(r => r.status === 'Dinas Luar').length
            };
            
            const total = stats.hadir + stats.sakit + stats.izin + stats.dinas;
            
            // Update total display
            document.getElementById('total-attendance').textContent = total;
            
            // Update legend
            document.getElementById('legend-hadir').textContent = stats.hadir;
            document.getElementById('legend-sakit').textContent = stats.sakit;
            document.getElementById('legend-izin').textContent = stats.izin;
            document.getElementById('legend-dinas').textContent = stats.dinas;
            
            if (total === 0) {
                // Reset all circles to 0
                document.getElementById('chart-hadir').style.strokeDasharray = '0 251.2';
                document.getElementById('chart-sakit').style.strokeDasharray = '0 251.2';
                document.getElementById('chart-izin').style.strokeDasharray = '0 251.2';
                document.getElementById('chart-dinas').style.strokeDasharray = '0 251.2';
                return;
            }
            
            const circumference = 2 * Math.PI * 40; // 2Ï€r where r=40
            let currentOffset = 0;
            
            // Calculate and set stroke-dasharray for each segment
            const hadirLength = (stats.hadir / total) * circumference;
            const sakitLength = (stats.sakit / total) * circumference;
            const izinLength = (stats.izin / total) * circumference;
            const dinasLength = (stats.dinas / total) * circumference;
            
            // Hadir segment
            document.getElementById('chart-hadir').style.strokeDasharray = `${hadirLength} ${circumference - hadirLength}`;
            document.getElementById('chart-hadir').style.strokeDashoffset = -currentOffset;
            currentOffset += hadirLength;
            
            // Sakit segment
            document.getElementById('chart-sakit').style.strokeDasharray = `${sakitLength} ${circumference - sakitLength}`;
            document.getElementById('chart-sakit').style.strokeDashoffset = -currentOffset;
            currentOffset += sakitLength;
            
            // Izin segment
            document.getElementById('chart-izin').style.strokeDasharray = `${izinLength} ${circumference - izinLength}`;
            document.getElementById('chart-izin').style.strokeDashoffset = -currentOffset;
            currentOffset += izinLength;
            
            // Dinas segment
            document.getElementById('chart-dinas').style.strokeDasharray = `${dinasLength} ${circumference - dinasLength}`;
            document.getElementById('chart-dinas').style.strokeDashoffset = -currentOffset;
        }

        function updateWeeklyChart() {
            const today = new Date();
            const weekData = [];
            const dayNames = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            // Get data for last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                const dayAttendance = attendanceRecords.filter(record => 
                    record.tanggal === dateString && record.status === 'Hadir'
                );
                
                weekData.push({
                    day: dayNames[date.getDay()],
                    count: dayAttendance.length,
                    date: dateString
                });
            }
            
            // Find max count for scaling
            const maxCount = Math.max(...weekData.map(d => d.count), 1);
            
            // Update bars
            weekData.forEach((data, index) => {
                const percentage = maxCount > 0 ? (data.count / maxCount) * 100 : 0;
                const bar = document.getElementById(`bar-${index}`);
                const dayLabel = document.getElementById(`day-${index}`);
                const countLabel = document.getElementById(`count-${index}`);
                
                if (bar && dayLabel && countLabel) {
                    bar.style.height = `${percentage}%`;
                    dayLabel.textContent = data.day;
                    countLabel.textContent = data.count;
                    
                    // Highlight today's bar
                    if (data.date === today.toISOString().split('T')[0]) {
                        bar.className = 'bg-white rounded-t transition-all duration-500 border-2 border-red-500';
                        dayLabel.className = 'text-xs mt-2 text-center font-bold text-red-600';
                    } else {
                        bar.className = 'bg-red-500 rounded-t transition-all duration-500';
                        dayLabel.className = 'text-xs mt-2 text-center';
                    }
                }
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Hadir': return 'bg-green-100 text-green-800';
                case 'Sakit': return 'bg-red-100 text-red-800';
                case 'Izin': return 'bg-yellow-100 text-yellow-800';
                case 'Dinas Luar': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'Hadir': return 'âœ…';
                case 'Sakit': return 'ğŸ¤’';
                case 'Izin': return 'ğŸ“';
                case 'Dinas Luar': return 'ğŸš—';
                case 'Tanpa Keterangan': return 'âŒ';
                default: return 'â“';
            }
        }

        function getStatusKepegawaianColor(status) {
            switch(status) {
                case 'PNS': return 'bg-green-100 text-green-800';
                case 'PPPK': return 'bg-blue-100 text-blue-800';
                case 'GTT': return 'bg-yellow-100 text-yellow-800';
                case 'GTY': return 'bg-purple-100 text-purple-800';
                case 'Honorer': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusKepegawaianIcon(status) {
            switch(status) {
                case 'PNS': return 'ğŸ‘¨â€ğŸ’¼';
                case 'PPPK': return 'ğŸ“‹';
                case 'GTT': return 'ğŸ“';
                case 'GTY': return 'ğŸ“';
                case 'Honorer': return 'ğŸ’¼';
                default: return 'â“';
            }
        }

        function getJabatanColor(jabatan) {
            switch(jabatan) {
                case 'Kepala Sekolah': return 'bg-purple-100 text-purple-800';
                case 'Wakil Kepala Sekolah': return 'bg-indigo-100 text-indigo-800';
                case 'Guru Kelas': return 'bg-green-100 text-green-800';
                case 'Guru Mata Pelajaran': return 'bg-blue-100 text-blue-800';
                case 'Guru Olahraga': return 'bg-orange-100 text-orange-800';
                case 'Guru Agama': return 'bg-teal-100 text-teal-800';
                case 'Guru Bahasa Inggris': return 'bg-cyan-100 text-cyan-800';
                case 'Guru Seni Budaya': return 'bg-pink-100 text-pink-800';
                case 'Guru BK': return 'bg-yellow-100 text-yellow-800';
                case 'Pustakawan': return 'bg-emerald-100 text-emerald-800';
                case 'Tenaga Administrasi': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getJabatanIcon(jabatan) {
            switch(jabatan) {
                case 'Kepala Sekolah': return 'ğŸ‘‘';
                case 'Wakil Kepala Sekolah': return 'ğŸ¯';
                case 'Guru Kelas': return 'ğŸ‘©â€ğŸ«';
                case 'Guru Mata Pelajaran': return 'ğŸ“š';
                case 'Guru Olahraga': return 'âš½';
                case 'Guru Agama': return 'ğŸ•Œ';
                case 'Guru Bahasa Inggris': return 'ğŸŒ';
                case 'Guru Seni Budaya': return 'ğŸ¨';
                case 'Guru BK': return 'ğŸ’¬';
                case 'Pustakawan': return 'ğŸ“–';
                case 'Tenaga Administrasi': return 'ğŸ“‹';
                default: return 'â“';
            }
        }

        async function editTeacher(teacherId) {
            const teacher = teachers.find(t => t.__backendId === teacherId);
            if (!teacher) return;
            
            document.getElementById('nama-guru').value = teacher.nama_guru;
            document.getElementById('nip-guru').value = teacher.nip;
            document.getElementById('jabatan-guru').value = teacher.jabatan;
            document.getElementById('status-kepegawaian').value = teacher.status_kepegawaian;
            
            editingTeacher = teacher;
            document.getElementById('submit-guru').textContent = 'âœï¸ Update Guru';
            document.getElementById('cancel-edit').classList.remove('hidden');
        }

        async function deleteTeacher(teacherId) {
            const teacher = teachers.find(t => t.__backendId === teacherId);
            if (!teacher) return;
            
            // Custom confirmation dialog
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md">
                    <h3 class="text-lg font-bold mb-4">Konfirmasi Hapus</h3>
                    <p class="mb-6">Apakah Anda yakin ingin menghapus data guru "${teacher.nama_guru}"?</p>
                    <div class="flex gap-4 justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Batal</button>
                        <button onclick="confirmDeleteTeacher('${teacherId}'); this.closest('.fixed').remove()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Hapus</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        async function confirmDeleteTeacher(teacherId) {
            const teacherIndex = teachers.findIndex(t => t.__backendId === teacherId);
            if (teacherIndex === -1) return;
            
            try {
                // Remove teacher from array
                teachers.splice(teacherIndex, 1);
                
                // Save to localStorage
                saveDataToStorage();
                
                // Update UI
                updateTeacherList();
                updateTeacherDropdown();
                
                showMessage('Data guru berhasil dihapus!', 'success');
            } catch (error) {
                console.error('Error deleting teacher:', error);
                showMessage('Gagal menghapus data guru. Silakan coba lagi.', 'error');
            }
        }

        function cancelEdit() {
            editingTeacher = null;
            document.getElementById('submit-guru').textContent = 'â• Tambah Guru';
            document.getElementById('cancel-edit').classList.add('hidden');
        }

        document.getElementById('cancel-edit').addEventListener('click', cancelEdit);

        function generateReport() {
            const bulan = document.getElementById('filter-bulan').value;
            const tahun = document.getElementById('filter-tahun').value;
            
            let filteredRecords = attendanceRecords;
            
            if (bulan || tahun) {
                filteredRecords = attendanceRecords.filter(record => {
                    const recordDate = new Date(record.tanggal);
                    const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                    const recordYear = String(recordDate.getFullYear());
                    
                    return (!bulan || recordMonth === bulan) && (!tahun || recordYear === tahun);
                });
            }
            
            // Get unique dates in the filtered period
            let uniqueDates = [...new Set(filteredRecords.map(record => record.tanggal))].sort();
            
            // If no filter is applied, get all working days in current month
            if (!bulan && !tahun) {
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                
                // Generate all working days (Monday to Friday) in current month up to today
                const workingDays = [];
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                
                for (let d = new Date(firstDay); d <= Math.min(lastDay, currentDate); d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    // Include Monday (1) to Friday (5), exclude Saturday (6) and Sunday (0)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        workingDays.push(d.toISOString().split('T')[0]);
                    }
                }
                
                // Merge with existing dates and remove duplicates
                uniqueDates = [...new Set([...uniqueDates, ...workingDays])].sort();
            }
            
            // Generate "Tanpa Keterangan" records for teachers who didn't attend on working days
            const extendedRecords = [...filteredRecords];
            
            uniqueDates.forEach(date => {
                teachers.forEach(teacher => {
                    const existingRecord = filteredRecords.find(record => 
                        record.tanggal === date && record.nama_guru === teacher.nama_guru
                    );
                    
                    if (!existingRecord) {
                        // Add "Tanpa Keterangan" record
                        extendedRecords.push({
                            type: 'attendance',
                            teacher_id: teacher.__backendId,
                            nama_guru: teacher.nama_guru,
                            status: 'Tanpa Keterangan',
                            jam_hadir: '-',
                            tanggal: date,
                            keterangan_lokasi: null,
                            created_at: new Date().toISOString(),
                            __backendId: `auto_${teacher.__backendId}_${date}` // Temporary ID for display
                        });
                    }
                });
            });
            
            // Calculate statistics including "Tanpa Keterangan"
            const stats = {
                hadir: extendedRecords.filter(r => r.status === 'Hadir').length,
                sakit: extendedRecords.filter(r => r.status === 'Sakit').length,
                izin: extendedRecords.filter(r => r.status === 'Izin').length,
                dinas: extendedRecords.filter(r => r.status === 'Dinas Luar').length,
                tanpaKeterangan: extendedRecords.filter(r => r.status === 'Tanpa Keterangan').length
            };
            
            document.getElementById('stat-hadir').textContent = stats.hadir;
            document.getElementById('stat-sakit').textContent = stats.sakit;
            document.getElementById('stat-izin').textContent = stats.izin;
            document.getElementById('stat-dinas').textContent = stats.dinas;
            document.getElementById('stat-tanpa-keterangan').textContent = stats.tanpaKeterangan;
            document.getElementById('statistics').classList.remove('hidden');
            document.getElementById('download-section').classList.remove('hidden');
            
            if (uniqueDates.length === 0) {
                document.getElementById('report-table').innerHTML = '<tr><td class="p-8 text-center text-gray-500 text-lg font-medium">ğŸ” Tidak ada data untuk periode yang dipilih</td></tr>';
                document.getElementById('resume-section').classList.add('hidden');
                return;
            }
            
            // Generate dynamic header with dates
            const header = document.getElementById('report-header');
            let headerHTML = '<tr>';
            headerHTML += '<th class="p-6 text-left sticky left-0 z-10 min-w-48 bg-gray-50">ğŸ‘¤ Nama Guru</th>';
            
            uniqueDates.forEach(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
                const dayName = dateObj.toLocaleDateString('id-ID', { weekday: 'short' });
                headerHTML += `<th class="p-3 text-center min-w-20">
                    <div class="text-xs font-bold">${formattedDate}</div>
                    <div class="text-xs text-gray-600">${dayName}</div>
                </th>`;
            });
            
            headerHTML += '<th class="p-3 text-center bg-green-50 font-bold">H</th>';
            headerHTML += '<th class="p-3 text-center bg-red-50 font-bold">S</th>';
            headerHTML += '<th class="p-3 text-center bg-yellow-50 font-bold">I</th>';
            headerHTML += '<th class="p-3 text-center bg-blue-50 font-bold">DL</th>';
            headerHTML += '<th class="p-3 text-center bg-gray-50 font-bold">TK</th>';
            headerHTML += '<th class="p-3 text-center bg-gray-100 font-bold">Total</th>';
            headerHTML += '</tr>';
            
            header.innerHTML = headerHTML;
            
            // Generate report data for each teacher
            const tbody = document.getElementById('report-table');
            let tableHTML = '';
            
            teachers.forEach(teacher => {
                const teacherRecords = extendedRecords.filter(record => record.nama_guru === teacher.nama_guru);
                
                // Count totals
                const totals = {
                    hadir: teacherRecords.filter(r => r.status === 'Hadir').length,
                    sakit: teacherRecords.filter(r => r.status === 'Sakit').length,
                    izin: teacherRecords.filter(r => r.status === 'Izin').length,
                    dinas: teacherRecords.filter(r => r.status === 'Dinas Luar').length,
                    tanpaKeterangan: teacherRecords.filter(r => r.status === 'Tanpa Keterangan').length
                };
                
                const totalKehadiran = totals.hadir + totals.sakit + totals.izin + totals.dinas + totals.tanpaKeterangan;
                
                tableHTML += '<tr>';
                tableHTML += `<td class="p-6 sticky left-0 bg-white z-10 font-medium">${teacher.nama_guru}</td>`;
                
                // Add daily attendance status
                uniqueDates.forEach(date => {
                    const dayRecord = teacherRecords.find(record => record.tanggal === date);
                    if (dayRecord) {
                        const statusIcon = getStatusIcon(dayRecord.status);
                        const statusColor = getStatusCellColor(dayRecord.status);
                        tableHTML += `<td class="p-3 text-center ${statusColor}" title="${dayRecord.status}">${statusIcon}</td>`;
                    } else {
                        tableHTML += '<td class="p-3 text-center bg-gray-100">-</td>';
                    }
                });
                
                // Add summary columns
                tableHTML += `<td class="p-3 text-center font-bold text-green-700">${totals.hadir}</td>`;
                tableHTML += `<td class="p-3 text-center font-bold text-red-700">${totals.sakit}</td>`;
                tableHTML += `<td class="p-3 text-center font-bold text-yellow-700">${totals.izin}</td>`;
                tableHTML += `<td class="p-3 text-center font-bold text-blue-700">${totals.dinas}</td>`;
                tableHTML += `<td class="p-3 text-center font-bold text-gray-700">${totals.tanpaKeterangan}</td>`;
                tableHTML += `<td class="p-3 text-center font-bold bg-gray-100">${totalKehadiran}</td>`;
                tableHTML += '</tr>';
            });
            
            tbody.innerHTML = tableHTML;
            
            // Generate resume
            generateResume(extendedRecords, uniqueDates, stats);
        }
        
        function getStatusCellColor(status) {
            switch(status) {
                case 'Hadir': return 'bg-green-100 text-green-800';
                case 'Sakit': return 'bg-red-100 text-red-800';
                case 'Izin': return 'bg-yellow-100 text-yellow-800';
                case 'Dinas Luar': return 'bg-blue-100 text-blue-800';
                case 'Tanpa Keterangan': return 'bg-gray-200 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function generateResume(filteredRecords, uniqueDates, stats) {
            const totalRecords = stats.hadir + stats.sakit + stats.izin + stats.dinas + stats.tanpaKeterangan;
            const totalDays = uniqueDates.length;
            const avgDaily = totalDays > 0 ? (totalRecords / totalDays).toFixed(1) : 0;
            
            // Update resume statistics
            document.getElementById('resume-total-days').textContent = `${totalDays} hari`;
            document.getElementById('resume-total-attendance').textContent = `${totalRecords} record`;
            document.getElementById('resume-avg-daily').textContent = `${avgDaily} guru`;
            
            // Calculate percentages
            if (totalRecords > 0) {
                document.getElementById('resume-percent-hadir').textContent = `${((stats.hadir / totalRecords) * 100).toFixed(1)}%`;
                document.getElementById('resume-percent-sakit').textContent = `${((stats.sakit / totalRecords) * 100).toFixed(1)}%`;
                document.getElementById('resume-percent-izin').textContent = `${((stats.izin / totalRecords) * 100).toFixed(1)}%`;
                document.getElementById('resume-percent-dinas').textContent = `${((stats.dinas / totalRecords) * 100).toFixed(1)}%`;
                document.getElementById('resume-percent-tanpa-keterangan').textContent = `${((stats.tanpaKeterangan / totalRecords) * 100).toFixed(1)}%`;
            } else {
                document.getElementById('resume-percent-hadir').textContent = '0%';
                document.getElementById('resume-percent-sakit').textContent = '0%';
                document.getElementById('resume-percent-izin').textContent = '0%';
                document.getElementById('resume-percent-dinas').textContent = '0%';
                document.getElementById('resume-percent-tanpa-keterangan').textContent = '0%';
            }
            
            // Calculate best and worst attendance
            const teacherStats = {};
            teachers.forEach(teacher => {
                const teacherRecords = filteredRecords.filter(record => record.nama_guru === teacher.nama_guru);
                const hadirCount = teacherRecords.filter(r => r.status === 'Hadir').length;
                const totalCount = teacherRecords.length;
                const attendanceRate = totalCount > 0 ? (hadirCount / totalCount) * 100 : 0;
                
                teacherStats[teacher.nama_guru] = {
                    hadir: hadirCount,
                    total: totalCount,
                    rate: attendanceRate
                };
            });
            
            // Find best attendance (highest rate and count)
            const bestTeachers = Object.entries(teacherStats)
                .filter(([name, stats]) => stats.total > 0)
                .sort((a, b) => b[1].rate - a[1].rate || b[1].hadir - a[1].hadir)
                .slice(0, 3);
            
            // Find teachers needing attention (low attendance rate)
            const attentionNeeded = Object.entries(teacherStats)
                .filter(([name, stats]) => stats.total > 0 && stats.rate < 80)
                .sort((a, b) => a[1].rate - b[1].rate)
                .slice(0, 3);
            
            // Update best attendance display
            if (bestTeachers.length > 0) {
                const bestHTML = bestTeachers.map(([name, stats], index) => {
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                    return `<div class="flex justify-between items-center mb-1">
                        <span>${medal} ${name}</span>
                        <span class="font-bold">${stats.rate.toFixed(1)}% (${stats.hadir}/${stats.total})</span>
                    </div>`;
                }).join('');
                document.getElementById('best-attendance').innerHTML = bestHTML;
            } else {
                document.getElementById('best-attendance').textContent = 'Belum ada data';
            }
            
            // Update attention needed display
            if (attentionNeeded.length > 0) {
                const attentionHTML = attentionNeeded.map(([name, stats]) => {
                    return `<div class="flex justify-between items-center mb-1">
                        <span>${name}</span>
                        <span class="font-bold">${stats.rate.toFixed(1)}% (${stats.hadir}/${stats.total})</span>
                    </div>`;
                }).join('');
                document.getElementById('attention-needed').innerHTML = attentionHTML;
            } else {
                document.getElementById('attention-needed').innerHTML = '<div class="text-green-600">âœ… Semua guru memiliki kehadiran baik (â‰¥80%)</div>';
            }
            
            // Show resume section
            document.getElementById('resume-section').classList.remove('hidden');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Logo Upload Functions
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const logoImg = document.getElementById('school-logo');
                    const logoContainer = document.getElementById('logo-container');
                    const removeBtn = document.getElementById('remove-logo');
                    
                    logoImg.src = event.target.result;
                    logoContainer.classList.remove('hidden');
                    removeBtn.classList.remove('hidden');
                    
                    // Store in localStorage for persistence
                    localStorage.setItem('school-logo', event.target.result);
                    
                    showMessage('Logo sekolah berhasil diupload!', 'success');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('remove-logo').addEventListener('click', function() {
            const logoContainer = document.getElementById('logo-container');
            const removeBtn = document.getElementById('remove-logo');
            
            logoContainer.classList.add('hidden');
            removeBtn.classList.add('hidden');
            
            // Remove from localStorage
            localStorage.removeItem('school-logo');
            
            // Reset file input
            document.getElementById('logo-upload').value = '';
            
            showMessage('Logo sekolah berhasil dihapus!', 'success');
        });

        function loadStoredImages() {
            // Load stored logo
            const storedLogo = localStorage.getItem('school-logo');
            if (storedLogo) {
                const logoImg = document.getElementById('school-logo');
                const logoContainer = document.getElementById('logo-container');
                const removeBtn = document.getElementById('remove-logo');
                
                logoImg.src = storedLogo;
                logoContainer.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
            }
        }

        // Download Functions
        function downloadExcel() {
            try {
                // Validate data first
                if (!attendanceRecords || attendanceRecords.length === 0) {
                    showMessage('âŒ Tidak ada data kehadiran. Silakan input data kehadiran terlebih dahulu.', 'error');
                    return;
                }

                if (!teachers || teachers.length === 0) {
                    showMessage('âŒ Tidak ada data guru. Silakan tambah data guru terlebih dahulu.', 'error');
                    return;
                }

                const bulan = document.getElementById('filter-bulan').value;
                const tahun = document.getElementById('filter-tahun').value;
                
                let filteredRecords = [...attendanceRecords];
                
                if (bulan || tahun) {
                    filteredRecords = attendanceRecords.filter(record => {
                        if (!record.tanggal) return false;
                        const recordDate = new Date(record.tanggal);
                        const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                        const recordYear = String(recordDate.getFullYear());
                        
                        return (!bulan || recordMonth === bulan) && (!tahun || recordYear === tahun);
                    });
                }
                
                if (filteredRecords.length === 0) {
                    showMessage('âŒ Tidak ada data untuk periode yang dipilih. Silakan pilih periode lain atau input data kehadiran.', 'error');
                    return;
                }
                
                // Show loading state
                const originalText = event.target.textContent;
                event.target.textContent = 'â³ Memproses...';
                event.target.disabled = true;
                
                setTimeout(() => {
                    try {
                        // Create workbook data
                        const workbookData = [];
                        
                        // Header row
                        const uniqueDates = [...new Set(filteredRecords.map(record => record.tanggal))].sort();
                        const headerRow = ['Nama Guru', 'NIP', 'Jabatan'];
                        uniqueDates.forEach(date => {
                            const dateObj = new Date(date);
                            headerRow.push(dateObj.toLocaleDateString('id-ID'));
                        });
                        headerRow.push('Total Hadir', 'Total Sakit', 'Total Izin', 'Total Dinas Luar', 'Total Kehadiran');
                        workbookData.push(headerRow);
                        
                        // Data rows
                        teachers.forEach(teacher => {
                            const teacherRecords = filteredRecords.filter(record => record.nama_guru === teacher.nama_guru);
                            const row = [
                                teacher.nama_guru || '-', 
                                teacher.nip || '-', 
                                teacher.jabatan || '-'
                            ];
                            
                            // Daily attendance
                            uniqueDates.forEach(date => {
                                const dayRecord = teacherRecords.find(record => record.tanggal === date);
                                row.push(dayRecord ? dayRecord.status : '-');
                            });
                            
                            // Totals
                            const totals = {
                                hadir: teacherRecords.filter(r => r.status === 'Hadir').length,
                                sakit: teacherRecords.filter(r => r.status === 'Sakit').length,
                                izin: teacherRecords.filter(r => r.status === 'Izin').length,
                                dinas: teacherRecords.filter(r => r.status === 'Dinas Luar').length
                            };
                            
                            row.push(totals.hadir, totals.sakit, totals.izin, totals.dinas, 
                                    totals.hadir + totals.sakit + totals.izin + totals.dinas);
                            
                            workbookData.push(row);
                        });
                        
                        // Convert to CSV format with BOM for Excel compatibility
                        const csvContent = '\uFEFF' + workbookData.map(row => 
                            row.map(cell => {
                                const cellValue = String(cell || '').replace(/"/g, '""');
                                return `"${cellValue}"`;
                            }).join(',')
                        ).join('\r\n');
                        
                        const periodText = getPeriodText(bulan, tahun);
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        const filename = `Laporan_Kehadiran_${periodText}_${timestamp}.csv`;
                        
                        // Create and trigger download with better browser compatibility
                        const blob = new Blob([csvContent], { 
                            type: 'application/vnd.ms-excel;charset=utf-8;' 
                        });
                        
                        // Try multiple download methods for better compatibility
                        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                            // IE/Edge
                            window.navigator.msSaveOrOpenBlob(blob, filename);
                            showMessage('âœ… Laporan Excel berhasil didownload!', 'success');
                        } else {
                            // Modern browsers
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            link.style.display = 'none';
                            
                            // Add to DOM, click, then remove
                            document.body.appendChild(link);
                            link.click();
                            
                            // Clean up after a short delay
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);
                            
                            showMessage('âœ… Laporan Excel berhasil didownload! Periksa folder Downloads Anda.', 'success');
                        }
                    } catch (error) {
                        console.error('Error creating Excel file:', error);
                        showMessage('âŒ Gagal membuat file Excel. Silakan coba lagi.', 'error');
                    } finally {
                        // Reset button state
                        event.target.textContent = originalText;
                        event.target.disabled = false;
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error downloading Excel:', error);
                showMessage('âŒ Gagal mendownload laporan Excel. Silakan coba lagi.', 'error');
            }
        }
        
        function downloadCSV() {
            try {
                // Validate data first
                if (!attendanceRecords || attendanceRecords.length === 0) {
                    showMessage('âŒ Tidak ada data kehadiran. Silakan input data kehadiran terlebih dahulu.', 'error');
                    return;
                }

                if (!teachers || teachers.length === 0) {
                    showMessage('âŒ Tidak ada data guru. Silakan tambah data guru terlebih dahulu.', 'error');
                    return;
                }

                const bulan = document.getElementById('filter-bulan').value;
                const tahun = document.getElementById('filter-tahun').value;
                
                let filteredRecords = [...attendanceRecords];
                
                if (bulan || tahun) {
                    filteredRecords = attendanceRecords.filter(record => {
                        if (!record.tanggal) return false;
                        const recordDate = new Date(record.tanggal);
                        const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                        const recordYear = String(recordDate.getFullYear());
                        
                        return (!bulan || recordMonth === bulan) && (!tahun || recordYear === tahun);
                    });
                }
                
                if (filteredRecords.length === 0) {
                    showMessage('âŒ Tidak ada data untuk periode yang dipilih. Silakan pilih periode lain atau input data kehadiran.', 'error');
                    return;
                }
                
                // Show loading state
                const originalText = event.target.textContent;
                event.target.textContent = 'â³ Memproses...';
                event.target.disabled = true;
                
                setTimeout(() => {
                    try {
                        // Create detailed CSV data
                        const csvData = [];
                        csvData.push(['Tanggal', 'Nama Guru', 'NIP', 'Jabatan', 'Status Kehadiran', 'Jam Hadir', 'Keterangan Lokasi', 'GPS Latitude', 'GPS Longitude', 'GPS Akurasi', 'GPS Alamat']);
                        
                        filteredRecords.forEach(record => {
                            const teacher = teachers.find(t => t.nama_guru === record.nama_guru);
                            const dateObj = new Date(record.tanggal);
                            
                            csvData.push([
                                dateObj.toLocaleDateString('id-ID') || '-',
                                record.nama_guru || '-',
                                teacher ? (teacher.nip || '-') : '-',
                                teacher ? (teacher.jabatan || '-') : '-',
                                record.status || '-',
                                record.jam_hadir || '-',
                                record.keterangan_lokasi || '-',
                                record.gps_data ? record.gps_data.latitude.toFixed(6) : '-',
                                record.gps_data ? record.gps_data.longitude.toFixed(6) : '-',
                                record.gps_data ? `Â±${Math.round(record.gps_data.accuracy)}m` : '-',
                                record.gps_data && record.gps_data.address ? record.gps_data.address : '-'
                            ]);
                        });
                        
                        // Convert to CSV with BOM for proper encoding
                        const csvContent = '\uFEFF' + csvData.map(row => 
                            row.map(cell => {
                                const cellValue = String(cell || '').replace(/"/g, '""');
                                return `"${cellValue}"`;
                            }).join(',')
                        ).join('\r\n');
                        
                        const periodText = getPeriodText(bulan, tahun);
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        const filename = `Data_Kehadiran_Detail_${periodText}_${timestamp}.csv`;
                        
                        // Create and trigger download with better browser compatibility
                        const blob = new Blob([csvContent], { 
                            type: 'text/csv;charset=utf-8;' 
                        });
                        
                        // Try multiple download methods for better compatibility
                        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                            // IE/Edge
                            window.navigator.msSaveOrOpenBlob(blob, filename);
                            showMessage('âœ… File CSV berhasil didownload!', 'success');
                        } else {
                            // Modern browsers
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            link.style.display = 'none';
                            
                            // Add to DOM, click, then remove
                            document.body.appendChild(link);
                            link.click();
                            
                            // Clean up after a short delay
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);
                            
                            showMessage('âœ… File CSV berhasil didownload! Periksa folder Downloads Anda.', 'success');
                        }
                    } catch (error) {
                        console.error('Error creating CSV file:', error);
                        showMessage('âŒ Gagal membuat file CSV. Silakan coba lagi.', 'error');
                    } finally {
                        // Reset button state
                        event.target.textContent = originalText;
                        event.target.disabled = false;
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error downloading CSV:', error);
                showMessage('âŒ Gagal mendownload file CSV. Silakan coba lagi.', 'error');
            }
        }
        
        function downloadPDF() {
            try {
                // Validate data first
                if (!attendanceRecords || attendanceRecords.length === 0) {
                    showMessage('âŒ Tidak ada data kehadiran. Silakan input data kehadiran terlebih dahulu.', 'error');
                    return;
                }

                if (!teachers || teachers.length === 0) {
                    showMessage('âŒ Tidak ada data guru. Silakan tambah data guru terlebih dahulu.', 'error');
                    return;
                }

                const bulan = document.getElementById('filter-bulan').value;
                const tahun = document.getElementById('filter-tahun').value;
                
                let filteredRecords = [...attendanceRecords];
                
                if (bulan || tahun) {
                    filteredRecords = attendanceRecords.filter(record => {
                        if (!record.tanggal) return false;
                        const recordDate = new Date(record.tanggal);
                        const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                        const recordYear = String(recordDate.getFullYear());
                        
                        return (!bulan || recordMonth === bulan) && (!tahun || recordYear === tahun);
                    });
                }
                
                if (filteredRecords.length === 0) {
                    showMessage('âŒ Tidak ada data untuk periode yang dipilih. Silakan pilih periode lain atau input data kehadiran.', 'error');
                    return;
                }
                
                // Show loading state
                const originalText = event.target.textContent;
                event.target.textContent = 'â³ Memproses...';
                event.target.disabled = true;
                
                setTimeout(() => {
                    try {
                        // Create HTML content for PDF
                        const schoolName = document.getElementById('school-name').textContent || 'SDN Muhara';
                        const periodText = getPeriodText(bulan, tahun);
                        const currentDate = new Date().toLocaleDateString('id-ID');
                        
                        // Calculate statistics
                        const stats = {
                            hadir: filteredRecords.filter(r => r.status === 'Hadir').length,
                            sakit: filteredRecords.filter(r => r.status === 'Sakit').length,
                            izin: filteredRecords.filter(r => r.status === 'Izin').length,
                            dinas: filteredRecords.filter(r => r.status === 'Dinas Luar').length
                        };
                        
                        let htmlContent = `<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Kehadiran Guru - ${schoolName}</title>
    <style>
        @page {
            size: A4;
            margin: 1cm;
        }
        @media print {
            body { margin: 0; font-size: 12px; }
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            line-height: 1.4; 
            color: #333;
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }
        .header h1 { 
            margin: 0; 
            font-size: 20px; 
            font-weight: bold; 
            color: #dc2626;
        }
        .header h2 { 
            margin: 8px 0; 
            font-size: 18px; 
            color: #374151;
        }
        .header p { 
            margin: 5px 0; 
            font-size: 14px; 
            color: #6b7280;
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            margin: 25px 0; 
        }
        .stat-box { 
            text-align: center; 
            padding: 15px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            background: #f9fafb;
        }
        .stat-box .number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-box .label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }
        .stat-hadir { border-color: #10b981; background: #ecfdf5; }
        .stat-hadir .number { color: #059669; }
        .stat-sakit { border-color: #ef4444; background: #fef2f2; }
        .stat-sakit .number { color: #dc2626; }
        .stat-izin { border-color: #f59e0b; background: #fffbeb; }
        .stat-izin .number { color: #d97706; }
        .stat-dinas { border-color: #3b82f6; background: #eff6ff; }
        .stat-dinas .number { color: #2563eb; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 25px; 
            font-size: 11px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #d1d5db; 
            padding: 8px 6px; 
            text-align: center; 
        }
        th { 
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); 
            color: white; 
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
        }
        .teacher-name { 
            text-align: left !important; 
            font-weight: 600; 
            background: #f9fafb;
            max-width: 120px;
            word-wrap: break-word;
        }
        .status-hadir { background-color: #d1fae5; color: #065f46; }
        .status-sakit { background-color: #fee2e2; color: #991b1b; }
        .status-izin { background-color: #fef3c7; color: #92400e; }
        .status-dinas { background-color: #dbeafe; color: #1e40af; }
        .total-col { background-color: #f3f4f6; font-weight: bold; }
        
        .footer { 
            margin-top: 50px; 
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .signature-box {
            text-align: center;
            min-width: 200px;
        }
        .signature-box p {
            margin: 5px 0;
            font-size: 12px;
        }
        .signature-line {
            border-bottom: 1px solid #333;
            margin: 40px 0 5px 0;
            height: 1px;
        }
        
        .print-instructions { 
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 20px; 
            margin: 20px 0; 
            text-align: center; 
        }
        .print-btn { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            font-size: 16px; 
            border-radius: 6px; 
            cursor: pointer;
            margin: 10px;
        }
        .print-btn:hover { 
            background: #2563eb; 
        }
        .instructions {
            font-size: 14px; 
            color: #1e40af;
            margin-top: 15px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="print-instructions no-print">
        <h3 style="margin-top: 0; color: #1e40af;">ğŸ“‹ Cara Download PDF</h3>
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Print / Save as PDF</button>
        <div class="instructions">
            <strong>Langkah-langkah:</strong><br>
            1. Klik tombol "Print / Save as PDF" di atas<br>
            2. Pilih "Save as PDF" atau "Microsoft Print to PDF" sebagai printer<br>
            3. Klik "Save" dan pilih lokasi penyimpanan<br>
            4. File PDF akan tersimpan di komputer Anda
        </div>
    </div>
    
    <div class="header">
        <h1>LAPORAN KEHADIRAN GURU</h1>
        <h2>${schoolName}</h2>
        <p><strong>Periode:</strong> ${periodText.replace(/_/g, ' ')}</p>
        <p><strong>Dicetak pada:</strong> ${currentDate}</p>
    </div>
    
    <div class="stats">
        <div class="stat-box stat-hadir">
            <div class="number">${stats.hadir}</div>
            <div class="label">Hadir</div>
        </div>
        <div class="stat-box stat-sakit">
            <div class="number">${stats.sakit}</div>
            <div class="label">Sakit</div>
        </div>
        <div class="stat-box stat-izin">
            <div class="number">${stats.izin}</div>
            <div class="label">Izin</div>
        </div>
        <div class="stat-box stat-dinas">
            <div class="number">${stats.dinas}</div>
            <div class="label">Dinas Luar</div>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th rowspan="2" class="teacher-name">Nama Guru</th>
                <th colspan="4">Rekap Kehadiran</th>
                <th rowspan="2">Total</th>
            </tr>
            <tr>
                <th>Hadir</th>
                <th>Sakit</th>
                <th>Izin</th>
                <th>Dinas</th>
            </tr>
        </thead>
        <tbody>`;
                        
                        // Add teacher data
                        teachers.forEach(teacher => {
                            const teacherRecords = filteredRecords.filter(record => record.nama_guru === teacher.nama_guru);
                            const totals = {
                                hadir: teacherRecords.filter(r => r.status === 'Hadir').length,
                                sakit: teacherRecords.filter(r => r.status === 'Sakit').length,
                                izin: teacherRecords.filter(r => r.status === 'Izin').length,
                                dinas: teacherRecords.filter(r => r.status === 'Dinas Luar').length
                            };
                            
                            const totalKehadiran = totals.hadir + totals.sakit + totals.izin + totals.dinas;
                            
                            htmlContent += `
            <tr>
                <td class="teacher-name">${teacher.nama_guru || '-'}</td>
                <td class="status-hadir">${totals.hadir}</td>
                <td class="status-sakit">${totals.sakit}</td>
                <td class="status-izin">${totals.izin}</td>
                <td class="status-dinas">${totals.dinas}</td>
                <td class="total-col">${totalKehadiran}</td>
            </tr>`;
                        });
                        
                        htmlContent += `
        </tbody>
    </table>
    
    <div class="footer">
        <div class="signature-box">
            <p><strong>Mengetahui,</strong></p>
            <p>Kepala Sekolah</p>
            <div class="signature-line"></div>
            <p>(_________________________)</p>
        </div>
        <div class="signature-box">
            <p><strong>Dibuat oleh,</strong></p>
            <p>Admin</p>
            <div class="signature-line"></div>
            <p>(_________________________)</p>
        </div>
    </div>
</body>
</html>`;
                        
                        // Create and download HTML file
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        const filename = `Laporan_Kehadiran_${periodText}_${timestamp}.html`;
                        
                        const blob = new Blob([htmlContent], { 
                            type: 'text/html;charset=utf-8;' 
                        });
                        
                        // Try multiple download methods for better compatibility
                        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                            // IE/Edge
                            window.navigator.msSaveOrOpenBlob(blob, filename);
                            showMessage('âœ… File HTML berhasil didownload! Buka file dan klik tombol Print untuk save as PDF.', 'success');
                        } else {
                            // Modern browsers
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            link.style.display = 'none';
                            
                            // Add to DOM, click, then remove
                            document.body.appendChild(link);
                            link.click();
                            
                            // Clean up after a short delay
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);
                            
                            showMessage('âœ… File HTML berhasil didownload! Buka file dan klik tombol Print untuk save as PDF.', 'success');
                        }
                    } catch (error) {
                        console.error('Error creating PDF file:', error);
                        showMessage('âŒ Gagal membuat file PDF. Silakan coba lagi.', 'error');
                    } finally {
                        // Reset button state
                        event.target.textContent = originalText;
                        event.target.disabled = false;
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                showMessage('âŒ Gagal mendownload laporan PDF. Silakan coba lagi.', 'error');
            }
        }
        
        function getPeriodText(bulan, tahun) {
            const monthNames = {
                '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
                '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
                '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
            };
            
            if (bulan && tahun) {
                return `${monthNames[bulan]}_${tahun}`;
            } else if (bulan) {
                return `${monthNames[bulan]}_${new Date().getFullYear()}`;
            } else if (tahun) {
                return `Tahun_${tahun}`;
            } else {
                return `Semua_Data_${new Date().getFullYear()}`;
            }
        }

        // GPS functionality
        let currentGPSData = null;

        // GPS Location Functions
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung oleh browser ini'));
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000 // Cache for 1 minute
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: position.timestamp
                        });
                    },
                    (error) => {
                        let errorMessage = 'Gagal mendapatkan lokasi GPS';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Akses lokasi ditolak. Silakan izinkan akses lokasi di browser.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Informasi lokasi tidak tersedia. Pastikan GPS aktif.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Timeout mendapatkan lokasi. Silakan coba lagi.';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        }

        async function reverseGeocode(latitude, longitude) {
            try {
                // Using OpenStreetMap Nominatim API (free, no API key required)
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'Aplikasi Kehadiran Guru SDN Muhara'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error('Gagal mendapatkan alamat');
                }
                
                const data = await response.json();
                
                if (data && data.display_name) {
                    return {
                        fullAddress: data.display_name,
                        shortAddress: formatShortAddress(data.address || {}),
                        details: data.address || {}
                    };
                } else {
                    return {
                        fullAddress: `Koordinat: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,
                        shortAddress: `Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`,
                        details: {}
                    };
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return {
                    fullAddress: `Koordinat: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,
                    shortAddress: `Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`,
                    details: {}
                };
            }
        }

        function formatShortAddress(addressDetails) {
            const parts = [];
            
            // Priority order for address components
            if (addressDetails.house_number && addressDetails.road) {
                parts.push(`${addressDetails.house_number} ${addressDetails.road}`);
            } else if (addressDetails.road) {
                parts.push(addressDetails.road);
            }
            
            if (addressDetails.suburb || addressDetails.neighbourhood) {
                parts.push(addressDetails.suburb || addressDetails.neighbourhood);
            }
            
            if (addressDetails.city || addressDetails.town || addressDetails.village) {
                parts.push(addressDetails.city || addressDetails.town || addressDetails.village);
            }
            
            return parts.length > 0 ? parts.join(', ') : 'Alamat tidak diketahui';
        }

        async function handleGPSRequest() {
            const gpsButton = document.getElementById('get-gps-location');
            const gpsInfo = document.getElementById('gps-info');
            
            // Show loading state
            gpsButton.textContent = 'â³ GPS...';
            gpsButton.disabled = true;
            
            try {
                // Get GPS coordinates
                const location = await getCurrentLocation();
                
                // Update GPS info display
                document.getElementById('gps-coordinates').textContent = 
                    `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
                document.getElementById('gps-time').textContent = 
                    new Date(location.timestamp).toLocaleString('id-ID');
                document.getElementById('gps-accuracy').textContent = 
                    `Â±${Math.round(location.accuracy)} meter`;
                
                // Show GPS info panel
                gpsInfo.classList.remove('hidden');
                
                // Get address (async, don't wait for it)
                reverseGeocode(location.latitude, location.longitude).then(addressData => {
                    document.getElementById('gps-address').textContent = addressData.shortAddress;
                    
                    // Store complete GPS data
                    currentGPSData = {
                        ...location,
                        address: addressData
                    };
                });
                
                // Store basic GPS data immediately
                currentGPSData = {
                    ...location,
                    address: {
                        shortAddress: `Lat: ${location.latitude.toFixed(4)}, Lng: ${location.longitude.toFixed(4)}`,
                        fullAddress: `Koordinat: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`
                    }
                };
                
                showMessage('âœ… Lokasi GPS berhasil didapatkan!', 'success');
                
            } catch (error) {
                console.error('GPS Error:', error);
                showMessage(`âŒ ${error.message}`, 'error');
                gpsInfo.classList.add('hidden');
            } finally {
                // Reset button state
                gpsButton.textContent = 'ğŸŒ GPS';
                gpsButton.disabled = false;
            }
        }

        // GPS Event Listeners
        document.getElementById('get-gps-location').addEventListener('click', handleGPSRequest);

        document.getElementById('refresh-gps').addEventListener('click', handleGPSRequest);

        document.getElementById('use-gps-location').addEventListener('click', function() {
            if (currentGPSData && currentGPSData.address) {
                const keteranganInput = document.getElementById('keterangan-lokasi');
                
                // Set location text with GPS data
                const gpsLocationText = `GPS: ${currentGPSData.address.shortAddress}`;
                keteranganInput.value = gpsLocationText;
                
                // Hide GPS info
                document.getElementById('gps-info').classList.add('hidden');
                
                showMessage('âœ… Lokasi GPS berhasil digunakan!', 'success');
            } else {
                showMessage('âŒ Data GPS tidak tersedia. Silakan refresh GPS terlebih dahulu.', 'error');
            }
        });

        document.getElementById('close-gps').addEventListener('click', function() {
            document.getElementById('gps-info').classList.add('hidden');
        });

        // Initialize app when page loads
        initializeApp();
        loadStoredImages();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9988be753760244a',t:'MTc2MjE0MDExMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>