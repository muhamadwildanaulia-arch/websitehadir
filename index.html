<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplikasi Kehadiran Guru SDN Muhara</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background-color: #f9fafb; }
    .active-tab { background-color: #2563eb; color: white; }
    .tab-btn { cursor: pointer; }
    .hidden { display: none; }
  </style>
</head>
<body class="font-sans text-gray-800">

  <header class="bg-blue-600 text-white p-5 text-center shadow">
    <h1 class="text-2xl font-bold">Aplikasi Kehadiran Guru SDN Muhara</h1>
    <p id="current-date" class="text-sm"></p>
    <div id="clock" class="text-xl font-mono mt-1"></div>
  </header>

  <nav class="flex justify-center bg-blue-100 shadow">
    <div id="tab-kehadiran" class="tab-btn active-tab px-6 py-3" onclick="switchTab('kehadiran')">Kehadiran</div>
    <div id="tab-guru" class="tab-btn px-6 py-3" onclick="switchTab('guru')">Data Guru</div>
    <div id="tab-laporan" class="tab-btn px-6 py-3" onclick="switchTab('laporan')">Laporan</div>
  </nav>

  <!-- === TAB KEHADIRAN === -->
  <section id="content-kehadiran" class="p-6">
    <h2 class="text-xl font-semibold mb-4">Form Kehadiran Guru</h2>
    <form id="attendance-form" class="space-y-3">
      <select id="nama-guru-kehadiran" class="w-full border p-2 rounded" required>
        <option value="">-- Pilih Guru --</option>
      </select>
      <select id="status-kehadiran" class="w-full border p-2 rounded" required>
        <option value="Hadir">Hadir</option>
        <option value="Izin">Izin</option>
        <option value="Sakit">Sakit</option>
      </select>
      <input id="keterangan-lokasi" type="text" class="w-full border p-2 rounded" placeholder="Keterangan lokasi (opsional)">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Simpan Kehadiran</button>
    </form>

    <h3 class="text-lg font-semibold mt-8 mb-2">Daftar Kehadiran Hari Ini</h3>
    <table class="w-full border-collapse border text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Nama Guru</th>
          <th class="border p-2">Status</th>
          <th class="border p-2">Jam Hadir</th>
          <th class="border p-2">Lokasi</th>
          <th class="border p-2">Tanggal</th>
        </tr>
      </thead>
      <tbody id="attendance-list"></tbody>
    </table>
  </section>

  <!-- === TAB DATA GURU === -->
  <section id="content-guru" class="hidden p-6">
    <h2 class="text-xl font-semibold mb-4">Manajemen Data Guru</h2>
    <form id="guru-form" class="grid md:grid-cols-2 gap-3">
      <input id="nama-guru" type="text" class="border p-2 rounded" placeholder="Nama Guru" required>
      <input id="nip-guru" type="text" class="border p-2 rounded" placeholder="NIP">
      <input id="jabatan-guru" type="text" class="border p-2 rounded" placeholder="Jabatan">
      <select id="status-kepegawaian" class="border p-2 rounded">
        <option value="PNS">PNS</option>
        <option value="Non PNS">Non PNS</option>
      </select>
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 md:col-span-2">Tambah / Update Guru</button>
    </form>

    <h3 class="text-lg font-semibold mt-8 mb-2">Daftar Guru</h3>
    <table class="w-full border-collapse border text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Nama Guru</th>
          <th class="border p-2">NIP</th>
          <th class="border p-2">Jabatan</th>
          <th class="border p-2">Status</th>
          <th class="border p-2">Aksi</th>
        </tr>
      </thead>
      <tbody id="guru-list"></tbody>
    </table>
  </section>

  <!-- === TAB LAPORAN === -->
  <section id="content-laporan" class="hidden p-6">
    <h2 class="text-xl font-semibold mb-4">Laporan Kehadiran</h2>
    <p class="text-sm mb-3 text-gray-500">Menampilkan seluruh data kehadiran dari Google Sheet.</p>
    <table class="w-full border-collapse border text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Nama Guru</th>
          <th class="border p-2">Status</th>
          <th class="border p-2">Jam Hadir</th>
          <th class="border p-2">Tanggal</th>
          <th class="border p-2">Lokasi</th>
        </tr>
      </thead>
      <tbody id="laporan-list"></tbody>
    </table>
  </section>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKj5ohfsNaLRJ83pzSyz8CykGzl_Sw7FEMW4TkDmJErsh-X72hZCC9V8YA0S7YmWmk/exec";
let teachers = [];
let attendanceRecords = [];

/* === FUNGSI UMUM === */
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function switchTab(tab) {
  document.querySelectorAll('section[id^="content-"]').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
  document.getElementById(`content-${tab}`).classList.remove('hidden');
  document.getElementById(`tab-${tab}`).classList.add('active-tab');
}

/* === LOAD DATA === */
async function loadTeachers() {
  const res = await fetch(GOOGLE_SCRIPT_URL + '?sheet=guru');
  const data = await res.json();
  teachers = data.slice(1).map(r => ({ nama_guru: r[0], nip: r[1], jabatan: r[2], status: r[3] }));
  updateTeacherTable();
  updateTeacherDropdown();
}

async function loadAttendance() {
  const res = await fetch(GOOGLE_SCRIPT_URL + '?sheet=kehadiran');
  const data = await res.json();
  attendanceRecords = data.slice(1).map(r => ({ nama: r[0], status: r[1], jam: r[2], tgl: r[3], lokasi: r[4] }));
  updateAttendanceToday();
  updateLaporan();
}

/* === SIMPAN DATA === */
async function saveTeacher(d) {
  await fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ type: 'teacher', data: d })
  });
}

async function saveAttendance(d) {
  await fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ type: 'attendance', data: d })
  });
}

/* === UPDATE UI === */
function updateTeacherTable() {
  const tbody = document.getElementById('guru-list');
  if (teachers.length === 0) return tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Belum ada data</td></tr>';
  tbody.innerHTML = teachers.map((t, i) => `
    <tr>
      <td class="border p-2">${t.nama_guru}</td>
      <td class="border p-2">${t.nip}</td>
      <td class="border p-2">${t.jabatan}</td>
      <td class="border p-2">${t.status}</td>
      <td class="border p-2">
        <button class="text-blue-600" onclick="editGuru(${i})">Edit</button>
      </td>
    </tr>`).join('');
}

function updateTeacherDropdown() {
  const sel = document.getElementById('nama-guru-kehadiran');
  sel.innerHTML = '<option value="">-- Pilih Guru --</option>' +
    teachers.map(t => `<option>${t.nama_guru}</option>`).join('');
}

function updateAttendanceToday() {
  const tbody = document.getElementById('attendance-list');
  const today = new Date().toISOString().split('T')[0];
  const list = attendanceRecords.filter(r => r.tgl === today);
  if (!list.length) return tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Belum ada data hari ini</td></tr>';
  tbody.innerHTML = list.map(r => `
    <tr>
      <td class="border p-2">${r.nama}</td>
      <td class="border p-2">${r.status}</td>
      <td class="border p-2">${r.jam}</td>
      <td class="border p-2">${r.lokasi}</td>
      <td class="border p-2">${r.tgl}</td>
    </tr>`).join('');
}

function updateLaporan() {
  const tbody = document.getElementById('laporan-list');
  if (!attendanceRecords.length) return tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Belum ada data</td></tr>';
  tbody.innerHTML = attendanceRecords.map(r => `
    <tr>
      <td class="border p-2">${r.nama}</td>
      <td class="border p-2">${r.status}</td>
      <td class="border p-2">${r.jam}</td>
      <td class="border p-2">${r.tgl}</td>
      <td class="border p-2">${r.lokasi}</td>
    </tr>`).join('');
}

/* === EDIT DATA GURU === */
function editGuru(i) {
  const g = teachers[i];
  document.getElementById('nama-guru').value = g.nama_guru;
  document.getElementById('nip-guru').value = g.nip;
  document.getElementById('jabatan-guru').value = g.jabatan;
  document.getElementById('status-kepegawaian').value = g.status;
  switchTab('guru');
}

/* === EVENT FORM === */
document.getElementById('guru-form').addEventListener('submit', async e => {
  e.preventDefault();
  const data = {
    nama_guru: document.getElementById('nama-guru').value,
    nip: document.getElementById('nip-guru').value,
    jabatan: document.getElementById('jabatan-guru').value,
    status_kepegawaian: document.getElementById('status-kepegawaian').value,
    waktu_input: new Date().toLocaleString('id-ID')
  };
  await saveTeacher(data);
  alert('✅ Data guru disimpan');
  e.target.reset();
  loadTeachers();
});

document.getElementById('attendance-form').addEventListener('submit', async e => {
  e.preventDefault();
  const now = new Date();
  const data = {
    nama_guru: document.getElementById('nama-guru-kehadiran').value,
    status: document.getElementById('status-kehadiran').value,
    jam_hadir: now.toLocaleTimeString('id-ID'),
    tanggal: now.toISOString().split('T')[0],
    keterangan_lokasi: document.getElementById('keterangan-lokasi').value
  };
  await saveAttendance(data);
  alert('✅ Kehadiran disimpan');
  e.target.reset();
  loadAttendance();
});

/* === INISIALISASI === */
window.onload = async () => {
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  updateClock();
  setInterval(updateClock, 1000);
  await loadTeachers();
  await loadAttendance();
};
</script>

</body>
</html>
